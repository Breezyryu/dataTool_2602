---
template: design
version: 1.2
description: PDCA Design phase document template (between Plan and Do) with Clean Architecture and Convention support
variables:
  - feature: 데이터전처리개선
  - date: 2026-02-02
  - author: Antigravity
  - project: Battery Data Analysis
  - version: 1.0.0
---

# 데이터전처리개선 Design Document

> **Summary**: 데이터 전처리 모듈 구조 개선 및 고급 스무딩/분류 알고리즘 설계
>
> **Project**: Battery Data Analysis
> **Version**: 1.0.0
> **Author**: Antigravity
> **Date**: 2026-02-02
> **Status**: Draft
> **Planning Doc**: [데이터전처리개선.plan.md](../01-plan/features/데이터전처리개선.plan.md)

---

## 1. Overview

### 1.1 Design Goals

본 설계는 배터리 데이터 분석의 정확도와 코드 유지보수성을 높이기 위해 다음 목표를 달성하고자 합니다.
1.  **모듈화**: 전처리 과정을 `Loader`, `Cleaner`, `Smoother`, `Categorizer`, `Analyzer`로 명확히 분리하여 결합도를 낮춤.
2.  **확장성**: 새로운 스무딩 알고리즘이나 분류 로직을 쉽게 추가할 수 있는 인터페이스(Strategy Pattern 등) 도입.
3.  **정확성**: 노이즈에 강건한 dV/dQ 계산 및 다양한 조건(C-rate 등)을 고려한 정밀한 사이클 분류 구현.

### 1.2 Design Principles

- **Single Responsibility Principle (SRP)**: 각 모듈은 하나의 역할만 수행 (예: Smoother는 데이터 평활화만 담당).
- **Open/Closed Principle (OCP)**: 새로운 알고리즘 추가 시 기존 코드를 수정하지 않고 확장 가능하도록 설계.
- **Dependency Inversion Principle (DIP)**: 상위 모듈은 하위 모듈의 구현이 아닌 추상화에 의존.

---

## 2. Architecture

### 2.1 Component Diagram

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Data Loader    │────▶│  Data Cleaner   │────▶│  Data Smoother  │
│ (Read raw file) │     │ (Remove noise)  │     │(Savitzky-Golay) │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                       │
                                                       ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│     Result      │◀────│  dV/dQ Analyzer │◀────│ Cycle Categorizer │
│ (Visualization) │     │  (Peak Detect)  │     │ (Split Cycles)  │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 2.2 Data Flow

```
Raw Data (Excel/CSV) → DataFrame Load → Time/Capacity Reset → Smoothing (Optional) 
→ Cycle Split (Charge/Discharge) → dV/dQ Calculation → Peak Analysis → Report/Graph
```

### 2.3 Dependencies

| Component | Depends On | Purpose |
|-----------|-----------|---------|
| `smoothing` | `scipy.signal`, `numpy` | 신호 처리 및 필터링 |
| `categorization` | `pandas`, `numpy` | 데이터 그룹화 및 조건 검사 |
| `analysis` | `smoothing`, `categorization` | 전처리된 데이터를 바탕으로 분석 수행 |
| `pipeline` | all above | 전체 프로세스 조율 |

---

## 3. Data Model

### 3.1 Entity Definition

```python
# BatteryData Structure (Concept)
class BatteryData:
    def __init__(self, raw_data: pd.DataFrame):
        self.raw_data = raw_data
        self.processed_data = None
        self.cycles = {}  # {cycle_num: CycleData}
        self.metadata = {}

class CycleData:
    def __init__(self, cycle_num, charge_data, discharge_data):
        self.cycle_num = cycle_num
        self.charge = charge_data      # DataFrame
        self.discharge = discharge_data # DataFrame
        self.metrics = {}              # capacity, energy, efficiency, etc.
```

---

## 4. API Specification (Internal Modules)

### 4.1 Module Interfaces

#### `SmoothingStrategy` (Abstract Base Class)
| Method | Description | Input | Output |
|--------|-------------|-------|--------|
| `apply` | 스무딩 적용 | `pandas.Series` | `pandas.Series` |

#### `CycleCategorizer`
| Method | Description | Input | Output |
|--------|-------------|-------|--------|
| `categorize` | 사이클 분류 | `pandas.DataFrame` | `dict` (Cycle info) |

#### `DVDQAnalyzer`
| Method | Description | Input | Output |
|--------|-------------|-------|--------|
| `calculate_dvdq` | dV/dQ 계산 | `pandas.DataFrame` | `pandas.DataFrame` |

---

## 5. Implementation Details

### 5.1 Smoothing Logic
- **Savitzky-Golay Filter**: 다항식 회귀를 이동 윈도우 방식으로 적용. 피크 형상 보존에 유리.
- **Gaussian Filter**: 정규 분포 가중치 적용. 부드러운 곡선을 얻기에 유리하나 피크가 뭉개질 수 있음.
- **User Option**: Window size, Polynomial order 등을 파라미터로 조절 가능하게 함.

### 5.2 Cycle Categorization Logic
- **Step 1**: 전류(Current) 방향 전환(0을 지나는 시점) 감지.
- **Step 2**: 전압(Voltage) 상한/하한 도달 여부 확인.
- **Step 3**: 누적 용량(Capacity) 및 시간(Time)을 기준으로 사이클 분리.
- **Step 4**: C-rate 계산 (Current / Nominal Capacity) 후 조건별 태깅 (e.g., "1C Charge", "0.5C Discharge").

---

## 6. Error Handling

### 6.1 Exception Classes
- `DataLoadError`: 파일 읽기 실패.
- `PreprocessingError`: 필수 컬럼 누락, 데이터 타입 불일치 등.
- `AnalysisError`: 분석 불가(데이터 부족, NaN 발생 등).

### 6.2 Strategy
- 각 단계별 `try-except` 블록으로 예외 포착.
- 로그(`logging` 모듈)를 남겨 디버깅 용이성 확보.
- 사용자에게는 UI를 통해 간략한 에러 메시지 전달.

---

## 7. Test Plan

### 7.1 Test Scope

| Type | Target | Tool |
|------|--------|------|
| Unit Test | 각 스무딩 함수, 분류 로직 | `unittest` or `pytest` |
| Integration Test | 전체 파이프라인 (Load ~ Analyze) | `pytest` |
| Regression Test | 기존 결과와 신규 로직 결과 비교 | Custom Script |

### 7.2 Test Cases (Key)
- [ ] 노이즈가 심한 데이터에 스무딩 적용 시 SNR 개선 확인.
- [ ] 불규칙한 충방전 패턴 데이터의 정확한 사이클 분리 확인.
- [ ] 기존 버전과 동일한 데이터 처리 시 용량/효율 오차 0.1% 이내 확인.

---

## 8. Clean Architecture & Conventions

### 8.1 Layer Structure
- **Domain**: `BatteryData`, `CycleData` (데이터 구조)
- **Application**: `SmoothingStrategy`, `CycleCategorizer` (비즈니스 로직)
- **Infrastructure**: `DataLoader` (파일 I/O)

### 8.2 Coding Conventions
- **Naming**: Functions(`snake_case`), Classes(`PascalCase`), Constants(`UPPER_SNAKE_CASE`).
- **Typing**: Python Type Hints 적극 활용 (`def func(a: int) -> str:`).
- **Docstring**: Google Style Docstring 적용.

---

## 9. Implementation Guide

### 9.1 File Structure
```
dataprocess/
├── smoothing/
│   ├── __init__.py
│   ├── base.py       # Interface
│   ├── savitzky.py   # Implementation
│   └── gaussian.py   # Implementation
├── categorization/
│   ├── __init__.py
│   └── cycle_step.py
├── analysis/
│   ├── __init__.py
│   └── dvdq.py
└── pipeline.py       # Integration
```

### 9.2 Implementation Order
1.  [ ] `smoothing` 패키지 및 알고리즘 구현
2.  [ ] `categorization` 로직 구현
3.  [ ] `analysis` (dV/dQ) 로직 리팩토링 및 연동
4.  [ ] `pipeline` 통합 및 테스트

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 0.1 | 2026-02-02 | Initial draft | Antigravity |
