# 배터리 데이터 도구 - 버튼 기능 최적화 비교 분석

## 1. 개요

5개의 확인 버튼 함수에 대한 로직 비교 및 최적화 방안을 제시합니다.

- `step_confirm_button()` - Step 프로파일 분석
- `rate_confirm_button()` - Rate 프로파일 분석  
- `chg_confirm_button()` - 충전(Charge) 프로파일 분석
- `dchg_confirm_button()` - 방전(Discharge) 프로파일 분석
- `pro_continue_confirm_button()` - 연속 프로파일 분석

---

## 2. 공통 구조 분석

### 2.1 공통 패턴

모든 함수가 다음과 같은 유사한 구조를 공유합니다:

```python
# 1. 버튼 비활성화
self.XXXConfirm.setDisabled(True)

# 2. 초기 설정 로드
firstCrate, mincapacity, CycleNo, smoothdegree, mincrate, dqscale, dvscale = self.Profile_ini_set()

# 3. 전역 변수 및 카운터 초기화
global writer
write_column_num, folder_count, chnlcount, cyccount = 0, 0, 0, 0

# 4. Tkinter 루트 생성 및 숨김
root = Tk()
root.withdraw()

# 5. 경로 설정
pne_path = self.pne_path_setting()
all_data_folder = pne_path[0]
all_data_name = pne_path[1]

# 6. 버튼 재활성화
self.XXXConfirm.setEnabled(True)

# 7. 파일 저장 설정
if self.saveok.isChecked():
    save_file_name = filedialog.asksaveasfilename(...)
    writer = pd.ExcelWriter(save_file_name, engine="xlsxwriter")

# 8. 데이터 처리 루프
for i, cyclefolder in enumerate(all_data_folder):
    # 폴더 스캔 및 처리
    ...

# 9. 정리 작업
if self.saveok.isChecked() and save_file_name:
    writer.close()
self.progressBar.setValue(100)
plt.close()
```

### 2.2 변수 명명 규칙 비교

| 함수 | 카운터 변수명 | 특이사항 |
|------|--------------|---------|
| step_confirm_button | write_column_num, folder_count, chnlcount, cyccount | 일관성 부족 (column_num vs count) |
| rate_confirm_button | writecolno, foldercount, chnlcount, cyccount | 스네이크 케이스 불일치 |
| chg_confirm_button | foldercount, chnlcount, cyccount, writecolno | 순서 불일치 |
| dchg_confirm_button | foldercount, chnlcount, cyccount, writecolno | chg와 동일 |
| pro_continue_confirm_button | write_column_num, write_column_num2, folder_count... | 추가 변수 존재 |

---

## 3. 함수별 세부 분석

### 3.1 step_confirm_button

**목적**: Step 프로파일 데이터 시각화 및 저장

**특징**:
- 2가지 분기 로직: `CycProfile.isChecked()` 여부
  - True: 각 FolderBase별로 그래프 생성
  - False: 각 CycleNo별로 그래프 생성
- 6개 서브플롯 생성 (2×3)
- `.ect_saveok` 체크 시 CSV 저장 기능

**데이터 처리**:
```python
if not check_cycler(cyclefolder):
    temp = toyo_step_Profile_data(...)
else:
    temp = pne_step_Profile_data(...)
```

**그래프**:
- step_ax1~6: Voltage, C-rate, SOC, Temperature 등

**문제점**:
1. 중복 코드: CycProfile 분기의 그래프 생성 로직이 거의 동일
2. 변수명 불일치: `write_column_num` vs 다른 함수의 `writecolno`

---

### 3.2 rate_confirm_button

**목적**: Rate 프로파일 데이터 시각화 및 저장

**특징**:
- step_confirm_button과 유사한 구조
- `rateProfile` 데이터 사용
- `output_fig()` 호출 포함

**데이터 처리**:
```python
if not check_cycler(cyclefolder):
    Ratetemp = toyo_rate_Profile_data(...)
else:
    Ratetemp = pne_rate_Profile_data(...)
```

**그래프**:
- rate_ax1~6: Voltage (중복), C-rate (중복), SOC, Temperature

**문제점**:
1. step_confirm_button과 95% 코드 중복
2. 변수명: `Ratetemp`, `Ratenamelist` 등 불필요한 접두사

---

### 3.3 chg_confirm_button

**목적**: 충전 프로파일 데이터 시각화 및 저장

**특징**:
- `smoothdegree` 파라미터 추가 사용
- `graph_profile()` 함수 사용 (step/rate와 다름)
- dQdV, dVdQ 미분값 그래프 포함
- `chk_dqdv.isChecked()` 조건부 축 설정

**데이터 처리**:
```python
if not check_cycler(cyclefolder):
    Chgtemp = toyo_chg_Profile_data(..., smoothdegree)
else:
    Chgtemp = pne_chg_Profile_data(..., smoothdegree)
```

**그래프**:
- Chg_ax1~6: SOC-Voltage, dQdV/dVdQ, C-rate, Temperature
- 조건부 축 전환 로직

**문제점**:
1. 축 설정 로직 중복 (9597번 라인 중복)
2. CycProfile 분기 로직 중복
3. `os.path.isdir()` 체크 불일치 (step/rate엔 없음)

---

### 3.4 dchg_confirm_button

**목적**: 방전 프로파일 데이터 시각화 및 저장

**특징**:
- chg_confirm_button과 거의 동일한 구조
- DOD (Depth of Discharge) 사용
- 음수 dQdV/dVdQ 범위

**데이터 처리**:
```python
if not check_cycler(cyclefolder):
    Dchgtemp = toyo_dchg_Profile_data(..., smoothdegree)
else:
    Dchgtemp = pne_dchg_Profile_data(..., smoothdegree)
```

**그래프**:
- Chg_ax1~6 (변수명 주의!): DOD-Voltage, dQdV, dVdQ, Temperature
- 음수 축 설정: `(-5*dqscale, 0.5*dqscale)`

**문제점**:
1. **심각**: 변수명이 `Chg_ax`로 되어있어 혼동 가능
2. chg_confirm_button과 90% 코드 중복
3. 9713번 라인 버그: `self.dvscale` 대신 `dvscale` 사용해야 함

---

### 3.5 pro_continue_confirm_button

**목적**: 연속 프로파일 데이터 시각화 및 저장

**특징**:
- Step 범위 입력 체크 (`"-" in self.stepnum.toPlainText()`)
- OCV/CCV (Open Circuit Voltage / Closed Circuit Voltage) 추가
- 2개 시트 저장: Profile, OCV_CCV
- `write_column_num2` 추가 카운터

**데이터 처리**:
```python
temp = pne_Profile_continue_data(FolderBase, Step_CycNo, Step_CycEnd, ...)
```

**그래프**:
- step_ax1~6: Voltage, C-rate, SOC, OCV/CCV, Temperature
- OCV/CCV 마커 플롯 ('o')

**문제점**:
1. 입력 검증이 함수 시작 부분이 아닌 중간에 위치
2. Toyo cycler 미지원 (에러 메시지만 출력)
3. 10102~10116번 라인 중복 코드 (tab 추가 로직 2번)

---

## 4. 주요 문제점 요약

### 4.1 코드 중복

| 중복 영역 | 영향 받는 함수 | 중복률 |
|----------|---------------|--------|
| 초기화 로직 | 모든 함수 | ~95% |
| CycProfile 분기 | step, rate | ~90% |
| chg/dchg 분기 | chg, dchg | ~85% |
| 파일 저장 로직 | 모든 함수 | ~100% |
| Progress bar 업데이트 | 모든 함수 | ~100% |
| Legend 설정 | 모든 함수 | ~95% |

### 4.2 변수명 불일치

```python
# 문제 사례
write_column_num  # step, pro_continue
writecolno        # rate, chg, dchg
folder_count      # step, pro_continue
foldercount       # rate, chg, dchg

# 혼동 사례
Chg_ax1~6         # chg와 dchg 모두 사용 (dchg는 잘못된 네이밍)
```

### 4.3 버그 및 잠재적 오류

1. **dchg_confirm_button 9713번 라인**:
   ```python
   # 현재 (버그)
   graph_profile(..., -5*dvscale, 0.5*self.dvscale, 0.5*self.dvscale, ...)
   
   # 수정 필요
   graph_profile(..., -5*dvscale, 0.5*dvscale, 0.5*dvscale, ...)
   ```

2. **pro_continue_confirm_button 10102~10116번 라인**:
   - tab 추가 로직이 중복으로 2번 실행됨
   - `tab_no`가 불필요하게 증가

3. **save_file_name 미정의 처리 부족**:
   - `if save_file_name:` 체크 없이 사용하는 경우 존재

### 4.4 성능 이슈

1. **Tkinter root 불필요 생성**:
   ```python
   root = Tk()
   root.withdraw()
   # 사용되지 않음 (filedialog가 자체 생성)
   ```

2. **plt.close() 위치**:
   - 모든 루프가 끝난 후 한 번만 호출
   - 메모리 누적 가능성

---

## 5. 최적화 제안

### 5.1 공통 함수 추출

```python
class WindowClass:
    def _init_confirm_button(self, button_widget):
        """공통 초기화 로직"""
        button_widget.setDisabled(True)
        
        config = self.Profile_ini_set()
        pne_path = self.pne_path_setting()
        
        button_widget.setEnabled(True)
        
        return {
            'config': config,
            'folders': pne_path[0],
            'names': pne_path[1]
        }
    
    def _setup_file_writer(self, file_extension=".xlsx"):
        """파일 저장 설정"""
        save_file_name = None
        writer = None
        
        if self.saveok.isChecked():
            save_file_name = filedialog.asksaveasfilename(
                initialdir="D://", 
                title="Save File Name", 
                defaultextension=file_extension
            )
            if save_file_name:
                writer = pd.ExcelWriter(save_file_name, engine="xlsxwriter")
        
        return writer, save_file_name
    
    def _create_plot_tab(self, fig, tab_no):
        """탭 생성 공통 로직"""
        tab = QtWidgets.QWidget()
        tab_layout = QtWidgets.QVBoxLayout(tab)
        canvas = FigureCanvas(fig)
        toolbar = NavigationToolbar(canvas, None)
        
        tab_layout.addWidget(toolbar)
        tab_layout.addWidget(canvas)
        self.cycle_tab.addTab(tab, str(tab_no))
        self.cycle_tab.setCurrentWidget(tab)
        
        return tab, tab_layout
    
    def _setup_legend(self, axes_list, data_name, positions):
        """범례 설정 공통 로직"""
        if len(data_name) != 0:
            for ax, pos in zip(axes_list, positions):
                ax.legend(loc=pos)
        else:
            plt.legend(loc="center left", bbox_to_anchor=(1, 0.5))
```

### 5.2 변수명 표준화

```python
# 제안: 스네이크 케이스 일관 사용
class Counters:
    write_column: int = 0
    folder_count: int = 0
    channel_count: int = 0
    cycle_count: int = 0
    
    def reset(self):
        self.write_column = 0
        self.folder_count = 0
        self.channel_count = 0
        self.cycle_count = 0
```

### 5.3 Profile 처리 통합

```python
def _process_profile_data(self, folder_base, cycle_no, profile_type, 
                          cycler_path, config):
    """프로파일 데이터 처리 통합"""
    is_pne = check_cycler(cycler_path)
    
    handlers = {
        'step': (pne_step_Profile_data, toyo_step_Profile_data),
        'rate': (pne_rate_Profile_data, toyo_rate_Profile_data),
        'chg': (pne_chg_Profile_data, toyo_chg_Profile_data),
        'dchg': (pne_dchg_Profile_data, toyo_dchg_Profile_data)
    }
    
    pne_handler, toyo_handler = handlers[profile_type]
    handler = pne_handler if is_pne else toyo_handler
    
    return handler(folder_base, cycle_no, *config)
```

### 5.4 그래프 생성 팩토리 패턴

```python
class PlotFactory:
    @staticmethod
    def create_step_plot():
        """Step 프로파일 플롯 생성"""
        fig, axes = plt.subplots(nrows=2, ncols=3, figsize=(14, 10))
        return fig, axes
    
    @staticmethod
    def create_profile_plot():
        """충방전 프로파일 플롯 생성"""
        fig, axes = plt.subplots(nrows=2, ncols=3, figsize=(14, 10))
        return fig, axes
    
    @staticmethod
    def plot_step_data(axes, data, config, legend_name):
        """Step 데이터 플롯팅"""
        ax1, ax2, ax3, ax4, ax5, ax6 = axes.flatten()
        
        graph_step(data.TimeMin, data.Vol, ax1, 
                   config['vol_high'], config['vol_low'], 
                   config['vol_gap'], "Time(min)", "Voltage(V)", 
                   legend_name)
        # ... 나머지 플롯
```

### 5.5 리팩토링된 step_confirm_button 예시

```python
def step_confirm_button(self):
    # 초기화
    init_data = self._init_confirm_button(self.StepConfirm)
    config = init_data['config']
    folders = init_data['folders']
    names = init_data['names']
    
    # 파일 저장 설정
    writer, save_file_name = self._setup_file_writer()
    
    # 카운터 초기화
    counters = Counters()
    tab_no = 0
    
    # 메인 처리 루프
    for i, folder in enumerate(folders):
        if not os.path.isdir(folder):
            continue
            
        subfolders = [f.path for f in os.scandir(folder) if f.is_dir()]
        counters.folder_count += 1
        
        # 프로파일 타입별 처리
        self._process_by_profile_mode(
            subfolders, folder, i, names, config, 
            writer, save_file_name, counters, tab_no
        )
    
    # 정리
    self._cleanup(writer, save_file_name)
```

### 5.6 불필요한 코드 제거

```python
# 제거 대상
root = Tk()
root.withdraw()
# filedialog가 자체적으로 Tk 루트를 생성하므로 불필요
```

---

## 6. 우선순위별 개선 방안

### 우선순위 1 (긴급) - 버그 수정

1. **dchg_confirm_button 9713번 라인 수정**
   ```python
   # Before
   graph_profile(..., -5*dvscale, 0.5*self.dvscale, 0.5*self.dvscale, ...)
   
   # After
   graph_profile(..., -5*dvscale, 0.5*dvscale, 0.5*dvscale, ...)
   ```

2. **dchg_confirm_button 변수명 수정**
   ```python
   # Before
   Chg_ax1, Chg_ax2, ...
   
   # After
   Dchg_ax1, Dchg_ax2, ...
   ```

3. **pro_continue_confirm_button 중복 코드 제거** (10102~10116)

### 우선순위 2 (높음) - 공통 함수 추출

1. 초기화 로직 공통화 (`_init_confirm_button`)
2. 파일 저장 로직 공통화 (`_setup_file_writer`)
3. 탭 생성 로직 공통화 (`_create_plot_tab`)
4. 범례 설정 로직 공통화 (`_setup_legend`)

### 우선순위 3 (중간) - 변수명 표준화

1. 카운터 변수 통일
2. 임시 변수명 표준화 (temp → profile_data)
3. 축 변수명 일관성 확보

### 우선순위 4 (낮음) - 구조 개선

1. 팩토리 패턴 적용
2. 설정 클래스 분리
3. 에러 처리 강화

---

## 7. 예상 효과

### 7.1 코드 감소

- **현재**: 약 1,500줄 (5개 함수)
- **개선 후**: 약 800줄 (50% 감소)

### 7.2 유지보수성 향상

- 공통 로직 수정 시 한 곳만 변경
- 버그 발생 확률 감소
- 신규 프로파일 타입 추가 용이

### 7.3 성능 개선

- 불필요한 Tkinter root 생성 제거
- 메모리 누수 방지 (plt.close 위치 개선)
- Progress bar 업데이트 최적화

---

## 8. 적용 로드맵

### Phase 1: 버그 수정 (1주)
- dchg_confirm_button 버그 수정
- pro_continue_confirm_button 중복 코드 제거

### Phase 2: 공통 함수 추출 (2주)
- `_init_confirm_button` 구현 및 적용
- `_setup_file_writer` 구현 및 적용
- `_create_plot_tab` 구현 및 적용

### Phase 3: 리팩토링 (3주)
- step_confirm_button 리팩토링
- rate_confirm_button 리팩토링
- chg/dchg_confirm_button 통합 리팩토링

### Phase 4: 테스트 및 검증 (1주)
- 기존 기능 동작 검증
- 성능 비교 테스트
- 사용자 피드백 수집

---

## 9. 결론

5개의 확인 버튼 함수는 높은 코드 중복률(85~95%)과 일관성 없는 변수명, 일부 버그를 포함하고 있습니다. 공통 함수 추출과 표준화를 통해 코드량을 50% 감소시키고 유지보수성을 크게 향상시킬 수 있습니다.

**핵심 개선 사항**:
1. ✅ 공통 로직 추출 → 중복 코드 제거
2. ✅ 변수명 표준화 → 가독성 향상
3. ✅ 버그 수정 → 안정성 확보
4. ✅ 구조 개선 → 확장성 확보

**즉시 적용 가능한 개선**:
- dchg_confirm_button 변수명 및 버그 수정
- Tkinter root 생성 코드 제거
- 공통 초기화 함수 추출
